name: Build Modules

on:
  pull_request:
    branches: main
  push:
    branches: main

jobs:
  # Github Action to install Maven modules in the root directory 
  compile:
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: "17"
          distribution: "temurin"
      - name: Run maven install on bundle-core, serviceadapter-core, and bundleserver
        run: mvn install
        
      - name: Run gradle build on BundleClient, BundleTransport
        run: ./gradlew build

  call-auto-formatter:
    needs: compile
    if: ${{ always() && !contains(needs.changes.outputs.commit-author, 'github-actions[bot]')}}
    runs-on: ubuntu-latest

    steps:
      - name: Print previous commit author
        run: echo "Previous ${{ needs.changes.outputs.commit-author }}"

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          token: ${{ secrets.DDDTOKEN }}

      - name: Install IntelliJ IDEA
        run: |
          wget -q -O idea.tar.gz https://download.jetbrains.com/idea/ideaIC-2024.1.1.tar.gz
          tar -xzf idea.tar.gz

      - name: Format code
        run: |
          ./*/bin/format.sh -m *.java -r .

      - name: Commit changes
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if ! git diff --exit-code > /dev/null
          then
            git commit -a -m "Auto-format code"
            git push
          fi
