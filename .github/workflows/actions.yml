name: Build Modules
on:
  pull_request:
    branches: main

# test comment <-- REMOVE LATER
jobs:
  changes:
    runs-on: ubuntu-latest
    # permissions:
    #   pull-requests: read
    outputs:
      client: ${{ steps.filter.outputs.client }}
      transport: ${{ steps.filter.outputs.transport }}
      server: ${{ steps.filter.outputs.server }}
    steps:
      - uses: dorny/paths-filter@v3
        id: filter
        with: 
          filters: |
            client:
              - 'BundleClient/**'
            transport:
              - 'BundleTransport/**'
            server:
              - 'bundleserver/**'
          initial-fetch-depth: 1

  # Github Action to Compile BundleClient
  build-bundle-client:
    needs: changes
    if: ${{ needs.changes.outputs.client == 'true' }}
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup gradle
      uses: gradle/gradle-build-action@v2

    - name: Setup JDK 17
      uses: actions/setup-java@v3
      with: 
        java-version: '17'
        distribution: 'temurin'

    - name: Run gradle build on BundleClient
      working-directory: ./BundleClient
      run: ./gradlew build

  # Github Action to Compile BundleTransport
  build-bundle-transport:
    needs: changes
    if: ${{ needs.changes.outputs.transport == 'true' }}
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup gradle
      uses: gradle/gradle-build-action@v2

    - name: Setup JDK 17
      uses: actions/setup-java@v3
      with: 
        java-version: '17'
        distribution: 'temurin'

    - name: Run gradle build on BundleTransport
      working-directory: ./BundleTransport
      run: ./gradlew build

  # Github Action to Compile bundleserver
  build-bundle-server:
    needs: changes
    if: ${{ needs.changes.outputs.server == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup JDK 17
        uses: actions/setup-java@v3
        with: 
          java-version: '17'
          distribution: 'temurin'
      
      - name: Run maven package on BundleServer
        working-directory: ./bundleserver
        run: mvn package
