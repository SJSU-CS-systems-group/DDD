name: Build Modules

on:
  pull_request:
    branches: main
  push:
    branches: main

jobs:
  # Github Action to detect file changes between
  # main branch and pull request branch
  changes:
    runs-on: ubuntu-latest
    outputs:
      core: ${{ steps.filter.outputs.core }}
      client: ${{ steps.filter.outputs.client }}
      transport: ${{ steps.filter.outputs.transport }}
      server: ${{ steps.filter.outputs.server }}
      commit-author: ${{ steps.check.outputs.author }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}

      - name: Get previous commit author
        id: check
        run: echo "author=$(git show -s | grep Author)" >> $GITHUB_OUTPUT

      - name: Print previous commit author
        run: echo "Previous ${{ steps.check.outputs.author }}"

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          # Detect any changes to the following folders
          filters: |
            core:
              - 'bundle-core/**'
            client:
              - 'BundleClient/**'
            transport:
              - 'BundleTransport/**'
            server:
              - 'bundleserver/**'

  # Github Action to install Maven modules in the root directory 
  install-maven-modules:
    needs: changes
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: "17"
          distribution: "temurin"
      - name: Run maven install on bundle-core, serviceadapter-core, and bundleserver
        working-directory: ./
        run: mvn install

  # Github Action to install Gradle modules in the root directory
  install-gradle-modules:
    needs: changes
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: Setup JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: "17"
          distribution: "temurin"
          
      - name: Run gradle build on BundleClient, BundleTransport
        working-directory: ./
        run: ./gradlew build

  call-auto-formatter:
    needs:
      [
        changes,
        install-maven-modules,
        install-gradle-modules,
        
      ]
    if: ${{ always() && !contains(needs.changes.outputs.commit-author, 'github-actions[bot]')}}
    runs-on: ubuntu-latest

    steps:
      - name: Print previous commit author
        run: echo "Previous ${{ needs.changes.outputs.commit-author }}"

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          token: ${{ secrets.DDDTOKEN }}

      - name: Install IntelliJ IDEA
        run: |
          wget -q -O idea.tar.gz https://download.jetbrains.com/idea/ideaIC-2024.1.1.tar.gz
          tar -xzf idea.tar.gz

      - name: Format code
        run: |
          ./*/bin/format.sh -m *.java -r .

      - name: Commit changes
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if ! git diff --exit-code > /dev/null
          then
            git commit -a -m "Auto-format code"
            git push
          fi
